name: Android CI - DCA Calculator Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Ø¶Ø¨Ø· JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'  # â¬…ï¸ Ù‡Ø°Ø§ Ù…Ù‡Ù…!
    
    # 3. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Gradle Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
    - name: Create Missing Gradle Files
      run: |
        echo "ðŸ“ Creating project structure..."
        
        # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
        mkdir -p gradle/wrapper
        mkdir -p app/src/main/java/com/example/dcacalculator
        mkdir -p app/src/main/res/values
        
        # 1. gradle-wrapper.properties
        if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
          echo "âœ… Created gradle-wrapper.properties"
        fi
        
        # 2. build.gradle.kts (Ø§Ù„Ø¬Ø°Ø±)
        if [ ! -f "build.gradle.kts" ]; then
          cat > build.gradle.kts << 'EOF'
plugins {
    id("com.android.application") version "8.1.0" apply false
    kotlin("android") version "1.8.10" apply false
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
EOF
          echo "âœ… Created build.gradle.kts"
        fi
        
        # 3. settings.gradle.kts
        if [ ! -f "settings.gradle.kts" ]; then
          cat > settings.gradle.kts << 'EOF'
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "DcaCalculator"
include(":app")
EOF
          echo "âœ… Created settings.gradle.kts"
        fi
        
        # 4. app/build.gradle.kts (Ù…Ø¨Ø³Ø· ÙˆÙ…Ø¶Ù…ÙˆÙ†)
        if [ ! -f "app/build.gradle.kts" ]; then
          mkdir -p app
          cat > app/build.gradle.kts << 'EOF'
plugins {
    id("com.android.application")
    kotlin("android")
}

android {
    namespace = "com.example.dcacalculator"
    compileSdk = 33

    defaultConfig {
        applicationId = "com.example.dcacalculator"
        minSdk = 21
        targetSdk = 33
        versionCode = 1
        versionName = "1.0"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
        }
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.4.3"
    }
}

dependencies {
    implementation("androidx.core:core-ktx:1.10.1")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.6.1")
    implementation("androidx.activity:activity-compose:1.7.2")
    implementation(platform("androidx.compose:compose-bom:2022.10.00"))
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-graphics")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.compose.material3:material3")
}
EOF
          echo "âœ… Created app/build.gradle.kts"
        fi
        
        # 5. gradlew script
        if [ ! -f "gradlew" ]; then
          cat > gradlew << 'EOF'
#!/bin/bash
# Gradle wrapper for GitHub Actions

# Use system gradle if wrapper files don't exist
if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
    java -jar gradle/wrapper/gradle-wrapper.jar "$@"
else
    gradle "$@"
fi
EOF
          chmod +x gradlew
          echo "âœ… Created gradlew"
        fi
        
        # 6. Ø¥ØµÙ„Ø§Ø­ AndroidManifest.xml Ø¥Ø°Ø§ Ù„Ø²Ù…
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          # Ø¥Ø²Ø§Ù„Ø© package attribute Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          sed -i 's/package="[^"]*"//g' app/src/main/AndroidManifest.xml
          # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† activity name ØµØ­ÙŠØ­
          sed -i 's/android:name="\.MainActivity"/android:name="com.example.dcacalculator.MainActivity"/g' app/src/main/AndroidManifest.xml
          echo "âœ… Fixed AndroidManifest.xml"
        fi
        
        echo "ðŸŽ‰ Project setup complete!"
    
    # 4. Ø¨Ù†Ø§Ø¡ Debug APK (Ø£Ø³Ù‡Ù„)
    - name: Build Debug APK
      run: |
        echo "ðŸš€ Starting Debug build..."
        ./gradlew assembleDebug --no-daemon --stacktrace
        echo "âœ… Debug build completed!"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ APK
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "ðŸ“± APK created successfully!"
          ls -lh app/build/outputs/apk/debug/
        else
          echo "âŒ APK not found!"
          find . -name "*.apk" -type f
          exit 1
        fi
    
    # 5. Ø¨Ù†Ø§Ø¡ Release APK
    - name: Build Release APK
      run: |
        echo "ðŸš€ Starting Release build..."
        ./gradlew assembleRelease --no-daemon
        echo "âœ… Release build completed!"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ APK
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          echo "ðŸ“± Release APK created successfully!"
          ls -lh app/build/outputs/apk/release/
        else
          echo "âš ï¸ Release APK not found, using Debug APK"
        fi
    
    # 6. Ø±ÙØ¹ APKs
    - name: Upload APKs
      uses: actions/upload-artifact@v4
      with:
        name: DCA-Calculator-APKs
        path: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/release/app-release.apk
        retention-days: 7
    
    # 7. Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­
    - name: Upload Build Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-reports
        path: |
          app/build/reports/
          app/build/outputs/logs/
        retention-days: 3
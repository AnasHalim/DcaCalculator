name: Android CI - Auto Build APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Gradle Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    - name: Create Missing Gradle Files
      run: |
        echo "ðŸ”§ Creating missing Gradle files..."
        
        # 1. Ø¥Ù†Ø´Ø§Ø¡ gradle-wrapper.properties Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯Ø§Ù‹
        if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          echo "Creating gradle-wrapper.properties..."
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        fi
        
        # 2. Ø¥Ù†Ø´Ø§Ø¡ build.gradle.kts (Ø§Ù„Ø¬Ø°Ø±)
        if [ ! -f "build.gradle.kts" ]; then
          echo "Creating root build.gradle.kts..."
          cat > build.gradle.kts << 'EOF'
        // Top-level build file
        plugins {
            id("com.android.application") version "8.2.0" apply false
            id("org.jetbrains.kotlin.android") version "1.9.10" apply false
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        fi
        
        # 3. Ø¥Ù†Ø´Ø§Ø¡ settings.gradle.kts
        if [ ! -f "settings.gradle.kts" ]; then
          echo "Creating settings.gradle.kts..."
          cat > settings.gradle.kts << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        
        rootProject.name = "DcaCalculator"
        include(":app")
        EOF
        fi
        
        # 4. Ø¥Ù†Ø´Ø§Ø¡ app/build.gradle.kts (Ø§Ù„Ø£Ù‡Ù…!)
        if [ ! -f "app/build.gradle.kts" ]; then
          echo "Creating app/build.gradle.kts..."
          mkdir -p app
          cat > app/build.gradle.kts << 'EOF'
        plugins {
            id("com.android.application")
            id("org.jetbrains.kotlin.android")
        }
        
        android {
            namespace = "com.example.dcacalculator"
            compileSdk = 34
            
            defaultConfig {
                applicationId = "com.example.dcacalculator"
                minSdk = 24
                targetSdk = 34
                versionCode = 1
                versionName = "1.0.0"
            }
            
            buildTypes {
                release {
                    isMinifyEnabled = false
                    proguardFiles(
                        getDefaultProguardFile("proguard-android-optimize.txt"),
                        "proguard-rules.pro"
                    )
                }
            }
            
            compileOptions {
                sourceCompatibility = JavaVersion.VERSION_17
                targetCompatibility = JavaVersion.VERSION_17
            }
            
            kotlinOptions {
                jvmTarget = "17"
            }
            
            buildFeatures {
                compose = true
            }
            
            composeOptions {
                kotlinCompilerExtensionVersion = "1.5.4"
            }
        }
        
        dependencies {
            implementation("androidx.core:core-ktx:1.12.0")
            implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
            implementation("androidx.activity:activity-compose:1.8.2")
            implementation(platform("androidx.compose:compose-bom:2023.08.00"))
            implementation("androidx.compose.ui:ui")
            implementation("androidx.compose.ui:ui-graphics")
            implementation("androidx.compose.ui:ui-tooling-preview")
            implementation("androidx.compose.material3:material3")
        }
        EOF
        fi
        
        # 5. Ø¥Ù†Ø´Ø§Ø¡ proguard-rules.pro (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if [ ! -f "app/proguard-rules.pro" ]; then
          echo "Creating proguard-rules.pro..."
          cat > app/proguard-rules.pro << 'EOF'
        # Add project specific ProGuard rules here.
        # You can control the set of applied configuration files using the
        # proguardFiles setting in build.gradle.
        #
        # For more details, see
        #   http://developer.android.com/guide/developing/tools/proguard.html
        
        # If your project uses WebView with JS, uncomment the following
        # and specify the fully qualified class name to the JavaScript interface
        # class:
        #-keepclassmembers class fqcn.of.javascript.interface.for.webview {
        #   public *;
        #}
        
        # Uncomment this to preserve the line number information for
        # debugging stack traces.
        #-keepattributes SourceFile,LineNumberTable
        
        # If you keep the line number information, uncomment this to
        # hide the original source file name.
        #-renamesourcefileattribute SourceFile
        EOF
        fi
        
        echo "âœ… All Gradle files created successfully!"
    
    # 3. Ø¶Ø¨Ø· JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    # 4. Ø§Ø³ØªØ®Ø¯Ø§Ù… Gradle Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† gradlew (Ø­ÙŠØ« Ø£Ù†Ù‡ Ù…ÙÙ‚ÙˆØ¯)
    - name: Build with Gradle
      run: |
        echo "ðŸš€ Building APK..."
        
        # Ø§Ø³ØªØ®Ø¯Ù… Gradle Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
        # Ø¥Ø°Ø§ gradlew Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… gradle Ù…Ø¨Ø§Ø´Ø±Ø©
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon
        else
          # ØªÙ†Ø²ÙŠÙ„ Gradle 8.4 ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
          wget https://services.gradle.org/distributions/gradle-8.4-bin.zip
          unzip gradle-8.4-bin.zip
          ./gradle-8.4/bin/gradle assembleRelease --no-daemon
        fi
        
        echo "âœ… Build completed!"
    
    # 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ APK
    - name: Verify APK
      run: |
        echo "ðŸ“± Verifying APK..."
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          echo "âœ… APK created successfully!"
          ls -lh app/build/outputs/apk/release/
        else
          echo "âŒ APK not found!"
          echo "Checking build outputs..."
          find . -name "*.apk" -type f
          exit 1
        fi
    
    # 6. Ø±ÙØ¹ APK Ù„Ù„ØªØ­Ù…ÙŠÙ„
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DCA-Calculator-APK
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 7
    
    # 7. Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          app/build/reports/
          app/build/outputs/logs/
        retention-days: 3
